#!/usr/bin/env bash
# bin/detect <cf-app-name> <org-manifest.yml>

cf_app_name=$1
org_manifest=$2

rm -rf *

cf ssh $1 -c "cat app/app.tar.gz | base64" | base64 -D > app.tar.gz
cf ssh $1 -c "cat app/release.yml | base64" | base64 -D > release.yml

echo Constructing manifest.yml
cp $2 .
cat manifest.yml | grep -v "    deploybuildpack:" > tmp.yml && mv tmp.yml manifest.yml
cat manifest.yml | grep -v "  buildpack:" > tmp.yml && mv tmp.yml manifest.yml
cat manifest.yml | grep -v "  path:" > tmp.yml && mv tmp.yml manifest.yml
echo "  path: app" >> manifest.yml
echo "  buildpack: binary_buildpack" >> manifest.yml

lines_not_matching_env=`cat manifest.yml | grep -A1 "env:" | tail -1 | grep -v "^    .*" | wc -l`
if [ $lines_not_matching_env -eq 1  ]  
  then  
  echo Environment yaml section not set, remove declaration
  cat manifest.yml | grep -v "  env:" > tmp.yml && mv tmp.yml manifest.yml
fi

echo Constructing app folder
mkdir app
mv app.tar.gz app


cat release.yml | grep -A1000 "default_process_types:" | tail -n +2 > app/Procfile
rm release.yml

cd app
cat Procfile | head -1 | xargs | sed 's/.*:/& tar xzf app.tar.gz \&\& rm app.tar.gz \&\&/' > tmpprocfile
cat Procfile | tail -n +2 >> tmpprocfile
mv tmpprocfile Procfile

echo Extract and keep .profile.d directory, if it exists
mkdir tmp
cd tmp
tar xzf ../app.tar.gz
mv .profile.d ..
cd ..
rm -rf tmp
